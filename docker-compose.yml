name: dynode
secrets:
  pfx_password:
    external: true

services:
  source:
    image: source-dynode:latest
    build:
      context: ./source.dynode
    ports:
      - "3000:80"
    volumes:
      - asset-files:/app/dist/files
      - log-files:/app/dist/logs
    networks:
      - dynode-network
    depends_on:
      - mongo

  builder:
    image: builder-dynode:latest
    build:
      context: ./builder.dynode
      # Provide PFX_PASSWORD at build time if TLS assets are required; omitted here to avoid embedding secrets.
      # args:
      #   PFX_PASSWORD: ""
    ports:
      - "4000:80"
    networks:
      - dynode-network
    depends_on:
      - source
      - render

  render:
    image: render-dynode:latest
    build:
      context: ./render.dynode
    ports:
      - "5000:80"
    networks:
      - dynode-network
    depends_on:
      - source

  echo:
    image: echo-dynode:latest
    build:
      context: ./echo.dynode
    ports:
      - "7000:8080"
    networks:
      - dynode-network
    environment:
      - NODE_ENV=production
      - PORT=8080
      - PUBLIC_BASE_URL=http://localhost:7000
      - AUTH_SECRET=${AUTH_SECRET}
      - HEARTBEAT_INTERVAL_MS=30000
      - POST_CONTENT_MAX_BYTES=262144
      - RADIO_POST_BROADCAST_DELAY_SECONDS=30

  mongo:
    image: mongodb/mongodb-community-server:latest
    ports:
      - "32768:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - dynode-network
    environment:
      - MONGO_INITDB_DATABASE=dyna_content

networks:
  dynode-network:
    driver: bridge

volumes:
  mongo-data:
    external: true
    name: dynode_data
  asset-files:
    external: true
    name: dynode_assets
  log-files:
    external: true
    name: dynode_logs
